const { onRequest } = require("firebase-functions/v2/https");
const { defineSecret } = require("firebase-functions/params");
const admin = require("firebase-admin");
const cors = require("cors")({ origin: true });

// ğŸ”¹ Firebase Admin ì´ˆê¸°í™” (ì„œë²„ì—ì„œë§Œ Firebase ì„¤ì • ì‚¬ìš©)
admin.initializeApp();
const db = admin.firestore();

// ğŸ”¹ Firebase Secret í™˜ê²½ ë³€ìˆ˜ (ë³´ì•ˆ ê°•í™”)
const fbAuthDomain = defineSecret("FB_AUTH_DOMAIN");
const fbProjectId = defineSecret("FB_PROJECT_ID");
const fbStorageBucket = defineSecret("FB_STORAGE_BUCKET");
const fbApiKey = defineSecret("FB_API_KEY");
const fbMessagingSenderId = defineSecret("FB_MESSAGING_SENDER_ID"); // âœ… ì¶”ê°€ë¨
const fbAppId = defineSecret("FB_APP_ID"); // âœ… ì¶”ê°€ë¨

// ğŸ”¹ Firestoreì—ì„œ ê´€ë¦¬ì ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” API (getAdminCode)
exports.getAdminCode = onRequest(async (req, res) => {
    cors(req, res, async () => {
        try {
            const docRef = db.collection("AdminSettings").doc("settings");
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                return res.status(404).json({ error: "ê´€ë¦¬ì ì½”ë“œ ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
            }

            const data = docSnap.data();
            return res.status(200).json({ adminCode: data.adminCode });
        } catch (error) {
            console.error("ğŸš¨ ê´€ë¦¬ì ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            return res.status(500).json({ error: "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜", details: error.message });
        }
    });
});

// ğŸ”¹ Firebase í™˜ê²½ ë³€ìˆ˜ ê°€ì ¸ì˜¤ëŠ” API (ë³´ì•ˆ ê°•í™”)
exports.getFirebaseConfig = onRequest({ secrets: [fbAuthDomain, fbProjectId, fbStorageBucket, fbApiKey, fbMessagingSenderId, fbAppId] }, async (req, res) => {
    cors(req, res, async () => {
        try {
            // ğŸ”¹ Firebase ì¸ì¦ í† í° í™•ì¸ (ì¶”ê°€ ë³´ì•ˆ)
            const idToken = req.headers.authorization?.split("Bearer ")[1];
            if (!idToken) {
                return res.status(403).json({ error: "âŒ Unauthorized: Firebase ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤." });
            }

            // ğŸ”¹ Firebase Authenticationìœ¼ë¡œ ì‚¬ìš©ì ê²€ì¦
            const decodedToken = await admin.auth().verifyIdToken(idToken);
            console.log("âœ… ì¸ì¦ëœ ì‚¬ìš©ì:", decodedToken.uid);

            // ğŸ”¹ ì¸ì¦ëœ ì‚¬ìš©ìì—ê²Œë§Œ Firebase ì„¤ì • ë°˜í™˜
            res.json({
                authDomain: fbAuthDomain.value(),
                projectId: fbProjectId.value(),
                storageBucket: fbStorageBucket.value(),
                apiKey: fbApiKey.value(),
                messagingSenderId: fbMessagingSenderId.value(),
                appId: fbAppId.value(),
            });
        } catch (error) {
            console.error("âŒ Firebase ì¸ì¦ ì‹¤íŒ¨:", error);
            return res.status(403).json({ error: "âŒ Invalid token" });
        }
    });
});
